---
phase: 10-ux-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "Enabled/disabled state persists across app restarts"
    - "Toggling state saves to config file immediately"
    - "New installs default to enabled"
  artifacts:
    - path: "src/config.rs"
      provides: "AppSettings struct with enabled field"
      contains: "pub struct AppSettings"
    - path: "src/config.rs"
      provides: "Config struct with settings field"
      contains: "pub settings: AppSettings"
  key_links:
    - from: "src/main.rs"
      to: "config.settings.enabled"
      via: "Load enabled state on startup"
      pattern: "settings\\.enabled"
    - from: "src/main.rs"
      to: "save_config"
      via: "Save on toggle"
      pattern: "save_config.*toggle"
---

<objective>
Persist enabled/disabled state across app restarts.

Purpose: Users expect their preference to be remembered. Currently, the app always starts with macros enabled regardless of how it was last closed.

Output: Config file stores enabled state, loaded on startup, saved on toggle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ux-polish/10-RESEARCH.md

@src/config.rs
@src/main.rs
@src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AppSettings struct to config</name>
  <files>src/config.rs</files>
  <action>
Add new struct and integrate into Config:

```rust
/// Application-level settings persisted across restarts.
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub struct AppSettings {
    /// Whether macros are enabled (default: true for new installs)
    #[serde(default = "default_enabled")]
    pub enabled: bool,
}

fn default_enabled() -> bool {
    true
}

impl Default for AppSettings {
    fn default() -> Self {
        Self { enabled: true }
    }
}
```

Update Config struct to include settings field:
```rust
pub struct Config {
    #[serde(default = "default_version")]
    pub version: u32,
    #[serde(default)]
    pub macros: Vec<MacroDefinition>,
    /// Application settings (enabled state, etc.)
    #[serde(default)]
    pub settings: AppSettings,
}
```

Update Config::default() to include settings: AppSettings::default().

Add a test that verifies:
1. Config without settings field deserializes with enabled=true (default)
2. Config with settings.enabled=false deserializes correctly
3. Roundtrip serialization preserves settings
  </action>
  <verify>
`cargo test` passes, including new settings tests.
  </verify>
  <done>
AppSettings struct exists with enabled field. Config includes settings. Defaults work correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Load and save enabled state in main.rs</name>
  <files>src/main.rs</files>
  <action>
In resumed() when loading config:
- After loading final_config, set initial state from config:
  `self.state.enabled = final_config.settings.enabled;`
- This happens BEFORE build_menu() so the menu shows correct initial state

In the toggle menu event handler (where `event.id == self.menu_ids.toggle`):
- After `self.state.toggle()`, also update and save config:
```rust
if let Some(ref mut cfg) = self.config {
    cfg.settings.enabled = self.state.enabled;
    if let Err(e) = config::save_config(cfg) {
        eprintln!("Failed to save enabled state: {}", e);
    }
}
```

This ensures:
1. On startup: Load saved preference (or default to enabled)
2. On toggle: Save new preference immediately
  </action>
  <verify>
1. `cargo build --release` succeeds
2. Start app (first time) - macros are enabled
3. Toggle to disabled, quit app
4. Start app again - macros are still disabled
5. Check config.toml has `[settings]` section with `enabled = false`
  </verify>
  <done>
- Enabled state loaded from config on startup
- Toggle saves state immediately
- State persists across restarts
  </done>
</task>

</tasks>

<verification>
1. Fresh install (delete config.toml): App starts with macros enabled
2. Toggle to disabled, quit, restart: App starts with macros disabled
3. Toggle to enabled, quit, restart: App starts with macros enabled
4. Config file shows [settings] section with correct enabled value
</verification>

<success_criteria>
- UX-04 satisfied: Enabled/disabled state persists across restarts
- Default is enabled for new installs
- Toggle action saves immediately (no data loss on crash)
</success_criteria>

<output>
After completion, create `.planning/phases/10-ux-polish/10-02-SUMMARY.md`
</output>
