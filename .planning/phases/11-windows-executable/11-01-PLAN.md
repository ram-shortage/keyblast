---
phase: 11-windows-executable
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main.rs
  - Cargo.toml
  - build.rs
  - assets/icon.ico
autonomous: false
user_setup:
  - service: imagemagick
    why: "Convert PNG icon to multi-size ICO format for Windows"
    install: "brew install imagemagick"
    check: "magick --version"

must_haves:
  truths:
    - "Windows executable runs without spawning a console window"
    - "Windows executable shows custom icon in Explorer file listing"
    - "Windows executable shows custom icon in taskbar when running"
    - "Windows executable shows custom icon in Alt+Tab switcher"
    - "Cross-compilation from macOS still works"
  artifacts:
    - path: "src/main.rs"
      provides: "Windows subsystem attribute"
      contains: "#![windows_subsystem"
    - path: "build.rs"
      provides: "Windows resource compilation"
      contains: "winresource"
    - path: "Cargo.toml"
      provides: "Build script and dependency"
      contains: "[build-dependencies]"
    - path: "assets/icon.ico"
      provides: "Multi-size Windows icon"
      min_bytes: 1000
  key_links:
    - from: "build.rs"
      to: "assets/icon.ico"
      via: "set_icon path"
      pattern: 'set_icon.*icon\.ico'
    - from: "Cargo.toml"
      to: "build.rs"
      via: "build key"
      pattern: 'build\s*=\s*"build\.rs"'
---

<objective>
Create a professional Windows executable that hides the console window and displays the KeyBlast lightning bolt icon in Explorer, taskbar, and Alt+Tab.

Purpose: Windows users expect GUI applications to not spawn console windows and to have recognizable icons. This phase addresses both WIN-01 (console suppression) and WIN-02 (embedded icon).

Output: Modified main.rs, new build.rs, updated Cargo.toml, new icon.ico asset
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/11-windows-executable/11-RESEARCH.md

# Icon assets
@assets/icon.png

# Files to modify
@src/main.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Windows ICO file from PNG</name>
  <files>assets/icon.ico</files>
  <action>
Use ImageMagick to create a multi-size ICO file from the existing icon.png.

Command to run:
```bash
magick assets/icon.png -define icon:auto-resize="256,48,32,16" assets/icon.ico
```

This creates an ICO container with multiple resolutions:
- 256x256 for jumbo/tile view
- 48x48 for large icons
- 32x32 for medium icons
- 16x16 for small icons and file lists

Verify the ICO contains multiple sizes:
```bash
magick identify assets/icon.ico
```

Expected output: Multiple lines showing different dimensions (ICO[0], ICO[1], etc.)

IMPORTANT: If ImageMagick is not installed, the user must run `brew install imagemagick` first. Check with `magick --version`.
  </action>
  <verify>
- `ls -la assets/icon.ico` shows file exists and is > 1KB
- `magick identify assets/icon.ico` shows multiple size entries
  </verify>
  <done>assets/icon.ico exists with 16, 32, 48, and 256 pixel variants</done>
</task>

<task type="auto">
  <name>Task 2: Add Windows build infrastructure</name>
  <files>build.rs, Cargo.toml, src/main.rs</files>
  <action>
**Step 1: Create build.rs**

Create a new file `build.rs` in the project root (not in src/):

```rust
// build.rs - Windows resource compilation for icon embedding
fn main() {
    // Only compile Windows resources when targeting Windows
    // IMPORTANT: Use CARGO_CFG_TARGET_OS, not #[cfg(target_os)]
    // build.rs runs on HOST, cfg attributes reflect host OS
    if std::env::var("CARGO_CFG_TARGET_OS").unwrap() == "windows" {
        let mut res = winresource::WindowsResource::new();

        // Set the application icon (shows in Explorer, taskbar, Alt+Tab)
        res.set_icon("assets/icon.ico");

        // Version info auto-populated from Cargo.toml [package]:
        // - FileVersion from version
        // - ProductName from name
        // - FileDescription from description

        res.compile().unwrap();
    }
}
```

**Step 2: Update Cargo.toml**

Add two things:
1. Add `build = "build.rs"` to the `[package]` section (after edition line)
2. Add a new `[build-dependencies]` section with winresource

The [package] section should look like:
```toml
[package]
name = "keyblast"
version = "0.1.0"
edition = "2021"
build = "build.rs"
description = "A lightweight macro playback application that injects keystrokes via hotkeys"
license = "MIT"

# ... rest of file ...

[build-dependencies]
winresource = "0.1"
```

**Step 3: Update src/main.rs**

Add the Windows subsystem attribute at the VERY TOP of main.rs, before the doc comment:

```rust
#![windows_subsystem = "windows"]

/// KeyBlast - A lightweight macro playback application.
///
/// Sits in the system tray and provides hotkey-triggered keystroke injection.

mod app;
// ... rest of file unchanged ...
```

IMPORTANT notes:
- The `#![windows_subsystem = "windows"]` MUST be the first line (crate-level attribute)
- This attribute is silently ignored on non-Windows platforms
- This will disable stdout/stderr on Windows (but file logging already works via tracing-appender)
  </action>
  <verify>
- `grep -q 'windows_subsystem' src/main.rs && echo "OK"` returns OK
- `grep -q 'build = "build.rs"' Cargo.toml && echo "OK"` returns OK
- `grep -q 'winresource' Cargo.toml && echo "OK"` returns OK
- `test -f build.rs && echo "OK"` returns OK
  </verify>
  <done>
- build.rs exists with winresource configuration
- Cargo.toml has build key and winresource dependency
- main.rs has windows_subsystem attribute as first line
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify cross-compilation works</name>
  <files>None (verification only)</files>
  <action>
Build the Windows release executable from macOS to verify the resource compilation works.

Prerequisites:
- MinGW windres must be available (already confirmed: x86_64-w64-mingw32-windres v2.45)
- Windows GNU target must be installed

Verify target is installed:
```bash
rustup target list --installed | grep windows
```

If not present, add it:
```bash
rustup target add x86_64-pc-windows-gnu
```

Build Windows release:
```bash
cargo build --release --target x86_64-pc-windows-gnu
```

The build should complete without errors. The resulting executable will be at:
`target/x86_64-pc-windows-gnu/release/keyblast.exe`

Verify the exe exists and has reasonable size (should be larger than before due to embedded icon):
```bash
ls -la target/x86_64-pc-windows-gnu/release/keyblast.exe
```
  </action>
  <verify>
- `cargo build --release --target x86_64-pc-windows-gnu` completes with exit code 0
- `test -f target/x86_64-pc-windows-gnu/release/keyblast.exe && echo "OK"` returns OK
  </verify>
  <done>Cross-compilation produces keyblast.exe without errors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Windows executable with embedded icon and no console window</what-built>
  <how-to-verify>
Copy the built executable to a Windows machine and verify:

1. **No Console Window (WIN-01)**
   - Double-click keyblast.exe
   - Confirm: NO black console/terminal window appears
   - Confirm: Tray icon appears without any console

2. **Explorer Icon (WIN-02)**
   - Navigate to the folder containing keyblast.exe
   - Confirm: File shows lightning bolt icon (not generic exe icon)
   - Try different view modes (details, tiles, large icons)

3. **Taskbar Icon**
   - Run keyblast.exe
   - Confirm: Lightning bolt icon appears in taskbar/system tray

4. **Alt+Tab Icon**
   - With keyblast running, press Alt+Tab
   - Confirm: Lightning bolt icon appears in task switcher

The executable is located at:
`target/x86_64-pc-windows-gnu/release/keyblast.exe`
  </how-to-verify>
  <resume-signal>Type "approved" if all 4 checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
- [ ] assets/icon.ico exists with multiple sizes
- [ ] build.rs exists and references winresource
- [ ] Cargo.toml has build key and winresource in build-dependencies
- [ ] main.rs has #![windows_subsystem = "windows"] as first line
- [ ] Cross-compilation succeeds without errors
- [ ] Human verified: no console, icon shows in Explorer/taskbar/Alt+Tab
</verification>

<success_criteria>
- WIN-01: Windows executable runs without console window (human verified)
- WIN-02: Windows executable shows custom icon in Explorer, taskbar, Alt+Tab (human verified)
- Cross-compilation from macOS to Windows still works
- No regressions on macOS (attribute is ignored on non-Windows)
</success_criteria>

<output>
After completion, create `.planning/phases/11-windows-executable/11-01-SUMMARY.md`
</output>
