---
phase: 08-expanded-dsl
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/injection.rs
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "Parser recognizes {Delay 500} and produces Delay(500) segment"
    - "Parser recognizes {KeyDown Ctrl} and produces KeyDown(Key::Control) segment"
    - "Parser recognizes {KeyUp Shift} and produces KeyUp(Key::Shift) segment"
    - "Parser recognizes {Paste} and produces Paste segment"
    - "Parser converts {{ to literal { in output"
    - "Parser converts }} to literal } in output"
    - "Existing special keys ({Enter}, {Tab}, etc.) still work"
  artifacts:
    - path: "src/injection.rs"
      provides: "Extended MacroSegment enum, updated parser, modifier_key_from_name()"
      contains: "Delay(u64)"
    - path: "Cargo.toml"
      provides: "arboard dependency"
      contains: "arboard"
  key_links:
    - from: "parse_macro_sequence()"
      to: "MacroSegment::Delay"
      via: "parse_command() function"
      pattern: "Delay\\(.*\\)"
    - from: "parse_macro_sequence()"
      to: "MacroSegment::KeyDown"
      via: "parse_command() -> modifier_key_from_name()"
      pattern: "KeyDown\\(.*\\)"
---

<objective>
Extend the macro DSL parser to support new segment types (Delay, KeyDown, KeyUp, Paste) and brace escapes ({{ / }}).

Purpose: Enable advanced macro sequences with inline pauses, modifier key press/release for combos, clipboard paste, and literal brace characters in output.

Output: Updated injection.rs with expanded MacroSegment enum, enhanced parser, and arboard dependency added to Cargo.toml.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-expanded-dsl/08-RESEARCH.md

# Key files to understand
@src/injection.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend MacroSegment enum and add helper functions</name>
  <files>src/injection.rs</files>
  <action>
Extend the MacroSegment enum with new variants:

```rust
#[derive(Debug, Clone, PartialEq)]
pub enum MacroSegment {
    Text(String),
    SpecialKey(Key),
    Delay(u64),      // New: pause for N milliseconds
    KeyDown(Key),    // New: press and hold key
    KeyUp(Key),      // New: release key
    Paste,           // New: paste clipboard contents
}
```

Add a new function `modifier_key_from_name()` below `special_key_from_name()`:

```rust
fn modifier_key_from_name(name: &str) -> Option<Key> {
    match name.to_lowercase().as_str() {
        "ctrl" | "control" => Some(Key::Control),
        "shift" => Some(Key::Shift),
        "alt" => Some(Key::Alt),
        "meta" | "win" | "cmd" | "command" | "super" => Some(Key::Meta),
        "lctrl" | "lcontrol" => Some(Key::LControl),
        "rctrl" | "rcontrol" => Some(Key::RControl),
        "lshift" => Some(Key::LShift),
        "rshift" => Some(Key::RShift),
        _ => None,
    }
}
```

Note: enigo 0.6 uses `Key::Control`, `Key::Shift`, `Key::Alt`, `Key::Meta` for modifier keys, plus left/right variants like `Key::LControl`, `Key::RControl`, etc.
  </action>
  <verify>cargo check shows no errors for the new enum variants and helper function</verify>
  <done>MacroSegment has Delay(u64), KeyDown(Key), KeyUp(Key), Paste variants; modifier_key_from_name() exists and handles all documented modifier names</done>
</task>

<task type="auto">
  <name>Task 2: Refactor parser for parameterized commands and brace escapes</name>
  <files>src/injection.rs</files>
  <action>
Refactor `parse_macro_sequence()` to:

1. Handle brace escapes at the start of the main loop:
   - When encountering `{`, check if next char is also `{` -> output literal `{`
   - When encountering `}`, check if next char is also `}` -> output literal `}`

2. Extract command parsing into a separate `parse_command()` function that handles:
   - Parameterized commands: split on first space, lowercase the command name
   - "delay" + number -> `MacroSegment::Delay(ms)`
   - "keydown" + key name -> `MacroSegment::KeyDown(key)` via modifier_key_from_name()
   - "keyup" + key name -> `MacroSegment::KeyUp(key)` via modifier_key_from_name()
   - "paste" (no arg) -> `MacroSegment::Paste`
   - Fallback to existing special_key_from_name() for {Enter}, {Tab}, etc.

3. Add `flush_text()` helper to reduce duplication.

The research document (08-RESEARCH.md) has the complete implementation pattern. Key points:
- Use `chars.peekable()` for lookahead (already in use)
- `splitn(2, ' ')` to split command from argument
- Trim the argument to handle extra whitespace
- Case-insensitive matching via `.to_lowercase()`

Do NOT change execute_single_segment() yet - that's Task 3 in Plan 08-02.
  </action>
  <verify>
cargo test shows all existing parser tests pass plus:
- `parse_macro_sequence("{{")` returns `[Text("{")]`
- `parse_macro_sequence("}}")` returns `[Text("}")]`
- `parse_macro_sequence("{Delay 500}")` returns `[Delay(500)]`
- `parse_macro_sequence("{KeyDown Ctrl}")` returns `[KeyDown(Key::Control)]`
- `parse_macro_sequence("{KeyUp Shift}")` returns `[KeyUp(Key::Shift)]`
- `parse_macro_sequence("{Paste}")` returns `[Paste]`
  </verify>
  <done>Parser handles brace escapes and all new parameterized commands; existing tests pass; new tests cover all DSL-01 through DSL-04 parsing scenarios</done>
</task>

<task type="auto">
  <name>Task 3: Add arboard dependency and comprehensive tests</name>
  <files>Cargo.toml, src/injection.rs</files>
  <action>
Add arboard to Cargo.toml:

```toml
arboard = "3.6"
```

Add comprehensive parser tests to src/injection.rs covering:

1. Brace escape tests:
   - `"{{"` -> `[Text("{")]`
   - `"}}"` -> `[Text("}")]`
   - `"{{foo}}"` -> `[Text("{foo}")]`
   - `"a{{b}}c"` -> `[Text("a{b}c")]`

2. Delay tests:
   - `"{Delay 500}"` -> `[Delay(500)]`
   - `"{delay 100}"` -> `[Delay(100)]` (case insensitive)
   - `"{Delay}"` -> `[Text("{Delay}")]` (missing arg = literal)
   - `"{Delay abc}"` -> `[Text("{Delay abc}")]` (non-numeric = literal)

3. KeyDown/KeyUp tests:
   - `"{KeyDown Ctrl}"` -> `[KeyDown(Key::Control)]`
   - `"{keydown shift}"` -> `[KeyDown(Key::Shift)]`
   - `"{KeyUp Alt}"` -> `[KeyUp(Key::Alt)]`
   - `"{KeyDown Unknown}"` -> `[Text("{KeyDown Unknown}")]` (invalid key = literal)

4. Paste tests:
   - `"{Paste}"` -> `[Paste]`
   - `"{paste}"` -> `[Paste]` (case insensitive)

5. Mixed tests:
   - `"Hello{Delay 100}{Enter}World"` -> `[Text("Hello"), Delay(100), SpecialKey(Return), Text("World")]`
   - `"Type {{braces}}"` -> `[Text("Type "), Text("{braces}")]`

Note: arboard is added for Plan 08-02 (execution) but included here so compilation succeeds with future use of `arboard::Clipboard`.
  </action>
  <verify>
cargo build succeeds with arboard dependency
cargo test -- --nocapture shows all parser tests pass including new DSL tests
  </verify>
  <done>arboard dependency added; comprehensive test coverage for all new DSL features; all 29+ tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `cargo build` succeeds with no warnings in new code
2. `cargo test` passes all tests (original 29 + new DSL tests)
3. MacroSegment enum has 6 variants: Text, SpecialKey, Delay, KeyDown, KeyUp, Paste
4. Parser correctly handles: `{Delay N}`, `{KeyDown key}`, `{KeyUp key}`, `{Paste}`, `{{`, `}}`
5. Existing special keys ({Enter}, {Tab}, etc.) still work
6. Invalid/unknown commands treated as literal text (graceful fallback)
</verification>

<success_criteria>
- DSL-01 parsing: `{Delay 500}` produces Delay(500) segment
- DSL-02 parsing: `{KeyDown Ctrl}` / `{KeyUp Ctrl}` produce correct segments
- DSL-03 parsing: `{Paste}` produces Paste segment
- DSL-04 parsing: `{{` / `}}` produce literal braces in output
- All existing tests pass (no regression)
- arboard dependency available for Plan 08-02
</success_criteria>

<output>
After completion, create `.planning/phases/08-expanded-dsl/08-01-SUMMARY.md`
</output>
