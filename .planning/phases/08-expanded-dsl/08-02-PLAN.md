---
phase: 08-expanded-dsl
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/injection.rs
  - src/execution.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "User can pause mid-macro with {Delay 500}"
    - "User can hold modifier with {KeyDown Ctrl} and release with {KeyUp Ctrl}"
    - "User can paste clipboard contents with {Paste}"
    - "User can type literal braces with {{ and }}"
    - "Macros with Delay segments use async execution (not fast path)"
    - "Tray menu stays responsive during Delay execution"
  artifacts:
    - path: "src/injection.rs"
      provides: "execute_single_segment() handling all new segment types"
      contains: "MacroSegment::Paste"
    - path: "src/execution.rs"
      provides: "Delay-aware execution worker"
      contains: "MacroSegment::Delay"
    - path: "src/main.rs"
      provides: "Fast-path condition updated to exclude Delay segments"
      contains: "has_delay"
  key_links:
    - from: "src/execution.rs"
      to: "MacroSegment::Delay"
      via: "worker sends Inject, main thread sleeps"
      pattern: "Delay\\("
    - from: "src/injection.rs"
      to: "arboard::Clipboard"
      via: "execute_single_segment Paste handler"
      pattern: "Clipboard::new"
    - from: "src/main.rs"
      to: "has_delay"
      via: "fast-path condition check"
      pattern: "has_delay"
---

<objective>
Wire the new DSL segment types into execution, add clipboard integration, and update the fast-path condition.

Purpose: Make the expanded DSL actually work end-to-end so users can create macros with delays, modifier combos, clipboard paste, and literal braces.

Output: Fully functional expanded DSL with all four requirements (DSL-01 through DSL-04) working in both sync and async execution paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-expanded-dsl/08-RESEARCH.md
@.planning/phases/08-expanded-dsl/08-01-SUMMARY.md

# Key files
@src/injection.rs
@src/execution.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update execute_single_segment() for new segment types</name>
  <files>src/injection.rs</files>
  <action>
Add `use arboard::Clipboard;` at the top of injection.rs.

Update `execute_single_segment()` to handle all new segment types:

```rust
pub fn execute_single_segment(&mut self, segment: &MacroSegment) -> Result<(), InjectionError> {
    match segment {
        MacroSegment::Text(text) => {
            self.enigo.text(text)?;
        }
        MacroSegment::SpecialKey(key) => {
            self.enigo.key(*key, Direction::Click)?;
        }
        MacroSegment::Delay(ms) => {
            // Delay is handled by the caller (execution module or sync path)
            // This is a no-op here; the worker thread sleeps
            // For sync execution, sleep here:
            std::thread::sleep(std::time::Duration::from_millis(*ms));
        }
        MacroSegment::KeyDown(key) => {
            self.enigo.key(*key, Direction::Press)?;
        }
        MacroSegment::KeyUp(key) => {
            self.enigo.key(*key, Direction::Release)?;
        }
        MacroSegment::Paste => {
            // Read clipboard and type contents
            let mut clipboard = Clipboard::new()
                .map_err(|e| InjectionError(format!("Clipboard error: {}", e)))?;

            match clipboard.get_text() {
                Ok(text) => {
                    self.enigo.text(&text)?;
                }
                Err(e) => {
                    // Log but don't fail - clipboard might be empty or inaccessible
                    eprintln!("Warning: Could not read clipboard: {}", e);
                }
            }
        }
    }
    Ok(())
}
```

Also update `execute_sequence()` (sync path) to handle new segment types similarly. The Delay case should call `thread::sleep()` directly.

IMPORTANT: For KeyDown/KeyUp, use `Direction::Press` and `Direction::Release` respectively (not `Direction::Click`).
  </action>
  <verify>
cargo build succeeds
Manual test: Create a macro with `{Paste}` and verify it types clipboard contents
Manual test: Create a macro with `{KeyDown Shift}a{KeyUp Shift}` and verify it types "A"
  </verify>
  <done>execute_single_segment() handles all 6 segment types; Paste reads from clipboard and types; KeyDown/KeyUp use Press/Release directions</done>
</task>

<task type="auto">
  <name>Task 2: Update execution worker and fast-path condition</name>
  <files>src/execution.rs, src/main.rs</files>
  <action>
**In src/execution.rs:**

The execution worker currently sends all segments as `ExecutionCommand::Inject`. For Delay segments, we have two options:

Option A (simpler): Let the main thread handle Delay via execute_single_segment() which already sleeps.
Option B (more responsive): Worker sends Delay to main, main sleeps in small increments checking stop flag.

Use Option A for simplicity - execute_single_segment() handles the sleep. The delay happens on the main thread but that's acceptable since:
- Delays are intentional user-specified pauses
- The event loop processes commands one at a time anyway
- Stop flag check happens between segments in the worker

No changes needed to execution.rs - the existing code sends Inject(segment) for all segments.

**In src/main.rs:**

Update the fast-path condition to exclude macros containing Delay segments:

Find the line:
```rust
if macro_def.delay_ms == 0 && segments.len() <= 10 {
```

Change to:
```rust
let has_delay = segments.iter().any(|s| matches!(s, injection::MacroSegment::Delay(_)));
if macro_def.delay_ms == 0 && segments.len() <= 10 && !has_delay {
```

This ensures macros with `{Delay N}` always use async execution, keeping the tray menu responsive.

Also import `MacroSegment` if not already visible (it should be via `injection::MacroSegment`).
  </action>
  <verify>
cargo build succeeds
Create a test macro with `{Delay 2000}` - verify tray menu stays responsive during execution
Create a short macro without delay - verify it still uses fast path (check println output)
  </verify>
  <done>Fast-path condition excludes Delay segments; macros with {Delay N} use async execution; tray stays responsive</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end testing and documentation</name>
  <files>src/injection.rs</files>
  <action>
Add execution-focused tests to src/injection.rs to verify the new segment types work:

```rust
#[test]
fn test_parse_delay_segment() {
    let segments = parse_macro_sequence("{Delay 500}");
    assert_eq!(segments, vec![MacroSegment::Delay(500)]);
}

#[test]
fn test_parse_keydown_keyup() {
    let segments = parse_macro_sequence("{KeyDown Ctrl}c{KeyUp Ctrl}");
    assert_eq!(
        segments,
        vec![
            MacroSegment::KeyDown(Key::Control),
            MacroSegment::Text("c".to_string()),
            MacroSegment::KeyUp(Key::Control),
        ]
    );
}

#[test]
fn test_parse_paste() {
    let segments = parse_macro_sequence("prefix{Paste}suffix");
    assert_eq!(
        segments,
        vec![
            MacroSegment::Text("prefix".to_string()),
            MacroSegment::Paste,
            MacroSegment::Text("suffix".to_string()),
        ]
    );
}

#[test]
fn test_parse_brace_escapes_in_context() {
    // Template: Type JSON with escaped braces
    let segments = parse_macro_sequence(r#"{{"name": "test"}}"#);
    assert_eq!(
        segments,
        vec![MacroSegment::Text(r#"{"name": "test"}"#.to_string())]
    );
}

#[test]
fn test_complex_macro_with_all_features() {
    // Realistic macro: Type text, delay, paste clipboard
    let segments = parse_macro_sequence("Hello{Delay 100}{Enter}{{data}}: {Paste}");
    assert_eq!(
        segments,
        vec![
            MacroSegment::Text("Hello".to_string()),
            MacroSegment::Delay(100),
            MacroSegment::SpecialKey(Key::Return),
            MacroSegment::Text("{data}: ".to_string()),
            MacroSegment::Paste,
        ]
    );
}
```

Update the doc comment for `parse_macro_sequence()` to document the new syntax:

```rust
/// # Supported Commands
///
/// **Special Keys** (press and release):
/// - `{Enter}`, `{Tab}`, `{Escape}`, `{Backspace}`, etc.
///
/// **Delays**:
/// - `{Delay 500}` - Pause for 500 milliseconds
///
/// **Modifier Keys** (press/release separately):
/// - `{KeyDown Ctrl}`, `{KeyUp Ctrl}` - Hold/release Control
/// - `{KeyDown Shift}`, `{KeyUp Shift}` - Hold/release Shift
/// - Supported: Ctrl, Shift, Alt, Meta/Win/Cmd
///
/// **Clipboard**:
/// - `{Paste}` - Type current clipboard text contents
///
/// **Escape Sequences**:
/// - `{{` - Literal `{` character
/// - `}}` - Literal `}` character
```
  </action>
  <verify>
cargo test -- --nocapture passes all tests
cargo build --release succeeds
Manual end-to-end test:
1. Create macro: `Hello{Delay 1000}World{Enter}` - verify 1 second pause works
2. Create macro: `{Paste}` - verify clipboard contents are typed
3. Create macro: `{KeyDown Shift}hello{KeyUp Shift}` - verify "HELLO" is typed
4. Create macro: `{{json}}` - verify `{json}` is typed literally
  </verify>
  <done>All tests pass; documentation updated; end-to-end manual testing confirms all DSL features work</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `cargo build` succeeds with no new warnings
2. `cargo test` passes all tests (previous + new execution tests)
3. All four DSL requirements verified:
   - DSL-01: `{Delay 500}` pauses execution for 500ms
   - DSL-02: `{KeyDown Ctrl}` holds key, `{KeyUp Ctrl}` releases
   - DSL-03: `{Paste}` types clipboard text
   - DSL-04: `{{` and `}}` produce literal braces
4. Macros with Delay segments use async execution (tray stays responsive)
5. Short instant macros still use fast path (no regression)
</verification>

<success_criteria>
- DSL-01 execution: Macro with `{Delay 500}` pauses mid-execution
- DSL-02 execution: `{KeyDown Shift}a{KeyUp Shift}` produces "A"
- DSL-03 execution: `{Paste}` types current clipboard contents
- DSL-04 execution: `{{test}}` produces literal `{test}`
- Async execution: Macros with delays keep tray responsive
- No regression: Existing macros work unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/08-expanded-dsl/08-02-SUMMARY.md`
</output>
