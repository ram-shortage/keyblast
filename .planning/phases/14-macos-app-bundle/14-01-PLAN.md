---
phase: 14-macos-app-bundle
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/icon-256.png
  - assets/macos/icon_16x16.png
  - assets/macos/icon_16x16@2x.png
  - assets/macos/icon_32x32.png
  - assets/macos/icon_32x32@2x.png
  - assets/macos/icon_128x128.png
  - assets/macos/icon_128x128@2x.png
  - assets/macos/icon_256x256.png
  - assets/macos/icon_256x256@2x.png
  - assets/macos/icon_512x512.png
  - assets/macos/icon_512x512@2x.png
  - Cargo.toml
autonomous: true

must_haves:
  truths:
    - "macOS app is distributed as KeyBlast.app bundle"
    - "App shows lightning bolt icon in Finder"
    - "App shows lightning bolt icon in Dock when running"
    - "App bundle follows Apple conventions (Info.plist, .icns)"
  artifacts:
    - path: "assets/macos/icon_256x256.png"
      provides: "macOS icon source files"
    - path: "Cargo.toml"
      provides: "Bundle configuration"
      contains: "[package.metadata.bundle]"
    - path: "target/release/bundle/osx/KeyBlast.app/Contents/Info.plist"
      provides: "Apple bundle metadata"
    - path: "target/release/bundle/osx/KeyBlast.app/Contents/MacOS/keyblast"
      provides: "Executable binary"
    - path: "target/release/bundle/osx/KeyBlast.app/Contents/Resources/"
      provides: "Bundle resources including icon"
  key_links:
    - from: "Cargo.toml"
      to: "assets/macos/*.png"
      via: "bundle.icon array references"
      pattern: "icon = \\["
    - from: "cargo-bundle"
      to: "KeyBlast.app"
      via: "cargo bundle --release command"
---

<objective>
Create a professional macOS .app bundle for KeyBlast with custom lightning bolt icon.

Purpose: MAC-01 requires macOS app distribution as .app bundle with custom icon visible in Finder and Dock. This completes v2.1 Platform Polish milestone.

Output: target/release/bundle/osx/KeyBlast.app with proper bundle structure, Info.plist, and embedded .icns icon.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-macos-app-bundle/14-RESEARCH.md

@Cargo.toml
@assets/icon.ico
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate macOS icon set from existing icon.ico</name>
  <files>
    assets/icon-256.png
    assets/macos/icon_16x16.png
    assets/macos/icon_16x16@2x.png
    assets/macos/icon_32x32.png
    assets/macos/icon_32x32@2x.png
    assets/macos/icon_128x128.png
    assets/macos/icon_128x128@2x.png
    assets/macos/icon_256x256.png
    assets/macos/icon_256x256@2x.png
    assets/macos/icon_512x512.png
    assets/macos/icon_512x512@2x.png
  </files>
  <action>
    1. Extract 256x256 PNG from icon.ico:
       ```bash
       magick assets/icon.ico[0] assets/icon-256.png
       ```

    2. Create assets/macos/ directory:
       ```bash
       mkdir -p assets/macos
       ```

    3. Generate all required icon sizes using sips (macOS built-in):
       ```bash
       SOURCE="assets/icon-256.png"
       OUTDIR="assets/macos"

       # Scaling DOWN from 256 (good quality)
       sips -z 16 16     "$SOURCE" --out "$OUTDIR/icon_16x16.png"
       sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_16x16@2x.png"
       sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_32x32.png"
       sips -z 64 64     "$SOURCE" --out "$OUTDIR/icon_32x32@2x.png"
       sips -z 128 128   "$SOURCE" --out "$OUTDIR/icon_128x128.png"
       sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_128x128@2x.png"
       sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_256x256.png"

       # Scaling UP from 256 (quality compromise - acceptable)
       sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_256x256@2x.png"
       sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_512x512.png"
       sips -z 1024 1024 "$SOURCE" --out "$OUTDIR/icon_512x512@2x.png"
       ```

    Note: Scaling up from 256 to 512/1024 will cause some quality loss, but this is acceptable per research guidance. The icon will be sharp at most common display sizes.
  </action>
  <verify>
    ```bash
    ls -la assets/macos/*.png | wc -l
    # Should output: 10

    file assets/icon-256.png
    # Should show: PNG image data, 256 x 256

    file assets/macos/icon_512x512@2x.png
    # Should show: PNG image data, 1024 x 1024
    ```
  </verify>
  <done>
    - assets/icon-256.png exists (256x256)
    - assets/macos/ contains exactly 10 PNG files
    - All files follow Apple naming convention (icon_WxH.png, icon_WxH@2x.png)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure cargo-bundle in Cargo.toml</name>
  <files>Cargo.toml</files>
  <action>
    Add the following section to Cargo.toml AFTER the existing [build-dependencies] section:

    ```toml
    [package.metadata.bundle]
    name = "KeyBlast"
    identifier = "com.keyblast.app"
    icon = [
        "assets/macos/icon_16x16.png",
        "assets/macos/icon_16x16@2x.png",
        "assets/macos/icon_32x32.png",
        "assets/macos/icon_32x32@2x.png",
        "assets/macos/icon_128x128.png",
        "assets/macos/icon_128x128@2x.png",
        "assets/macos/icon_256x256.png",
        "assets/macos/icon_256x256@2x.png",
        "assets/macos/icon_512x512.png",
        "assets/macos/icon_512x512@2x.png",
    ]
    version = "0.1.0"
    copyright = "Copyright (c) 2026 KeyBlast"
    category = "public.app-category.productivity"
    short_description = "A lightweight macro playback application"
    osx_minimum_system_version = "10.13"
    ```

    Key points:
    - identifier is REQUIRED (reverse-DNS format)
    - icon array lists ALL 10 PNG files in assets/macos/
    - category matches app purpose (productivity tool)
    - osx_minimum_system_version = "10.13" (High Sierra+, supports features we use)
    - Do NOT set LSUIElement - app should appear in Dock when running
  </action>
  <verify>
    ```bash
    grep -A 5 '\[package.metadata.bundle\]' Cargo.toml
    # Should show bundle config with name = "KeyBlast"

    grep 'identifier' Cargo.toml
    # Should show: identifier = "com.keyblast.app"
    ```
  </verify>
  <done>
    - Cargo.toml contains [package.metadata.bundle] section
    - identifier = "com.keyblast.app" is set
    - All 10 icon files are listed in icon array
    - No LSUIElement key (app will appear in Dock)
  </done>
</task>

<task type="auto">
  <name>Task 3: Build .app bundle and verify structure</name>
  <files>target/release/bundle/osx/KeyBlast.app/</files>
  <action>
    1. Install cargo-bundle if not already installed:
       ```bash
       cargo install cargo-bundle
       ```

    2. Build the release .app bundle:
       ```bash
       cargo bundle --release
       ```

       This will:
       - Compile keyblast in release mode
       - Create target/release/bundle/osx/KeyBlast.app/
       - Generate Info.plist from Cargo.toml metadata
       - Convert PNG icons to .icns format
       - Copy executable to Contents/MacOS/

    3. Verify bundle structure:
       ```bash
       ls -la target/release/bundle/osx/KeyBlast.app/Contents/
       # Should show: Info.plist, MacOS/, Resources/

       ls target/release/bundle/osx/KeyBlast.app/Contents/MacOS/
       # Should show: keyblast (executable)

       ls target/release/bundle/osx/KeyBlast.app/Contents/Resources/
       # Should show: *.icns file
       ```

    4. Verify Info.plist has correct bundle identifier:
       ```bash
       /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" \
           target/release/bundle/osx/KeyBlast.app/Contents/Info.plist
       # Should output: com.keyblast.app
       ```

    5. Test launch the app:
       ```bash
       open target/release/bundle/osx/KeyBlast.app
       ```

       Verify:
       - App launches without error
       - Lightning bolt icon appears in Dock
       - App functions correctly (tray menu works, macros trigger)

    6. Check Finder icon appearance:
       - Open Finder, navigate to target/release/bundle/osx/
       - View KeyBlast.app in icon view - should show lightning bolt
       - Right-click > Get Info - icon should show in top-left
  </action>
  <verify>
    ```bash
    # Bundle exists
    test -d target/release/bundle/osx/KeyBlast.app && echo "Bundle exists"

    # Required structure
    test -f target/release/bundle/osx/KeyBlast.app/Contents/Info.plist && echo "Info.plist exists"
    test -f target/release/bundle/osx/KeyBlast.app/Contents/MacOS/keyblast && echo "Executable exists"
    ls target/release/bundle/osx/KeyBlast.app/Contents/Resources/*.icns 2>/dev/null && echo "ICNS exists"

    # Bundle identifier
    /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" \
        target/release/bundle/osx/KeyBlast.app/Contents/Info.plist
    ```
  </verify>
  <done>
    - KeyBlast.app bundle exists in target/release/bundle/osx/
    - Contents/Info.plist present with CFBundleIdentifier = com.keyblast.app
    - Contents/MacOS/keyblast executable present
    - Contents/Resources/ contains .icns icon file
    - App launches successfully from bundle
    - Lightning bolt icon visible in Dock when running
    - Lightning bolt icon visible in Finder
  </done>
</task>

</tasks>

<verification>
Phase 14 is complete when:

1. **Bundle structure correct:**
   ```bash
   test -d target/release/bundle/osx/KeyBlast.app/Contents/MacOS && \
   test -d target/release/bundle/osx/KeyBlast.app/Contents/Resources && \
   test -f target/release/bundle/osx/KeyBlast.app/Contents/Info.plist && \
   echo "Bundle structure valid"
   ```

2. **Icon embedded correctly:**
   ```bash
   ls target/release/bundle/osx/KeyBlast.app/Contents/Resources/*.icns
   # Should list .icns file
   ```

3. **App launches from bundle:**
   ```bash
   open target/release/bundle/osx/KeyBlast.app
   # App should launch, show in Dock with lightning bolt icon
   ```

4. **Finder displays icon:**
   - Navigate to bundle in Finder
   - Icon view shows lightning bolt
   - Get Info window shows lightning bolt in top-left corner
</verification>

<success_criteria>
- [ ] MAC-01 complete: macOS app distributed as .app bundle with custom icon
- [ ] Lightning bolt icon visible in Finder file listing
- [ ] Lightning bolt icon visible in Dock when app is running
- [ ] Bundle follows Apple conventions (Info.plist, .icns, proper structure)
- [ ] App launches and functions correctly from .app bundle
</success_criteria>

<output>
After completion, create `.planning/phases/14-macos-app-bundle/14-01-SUMMARY.md`
</output>
