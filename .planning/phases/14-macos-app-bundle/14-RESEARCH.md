# Phase 14: macOS App Bundle - Research

**Researched:** 2026-01-17
**Domain:** macOS application bundling (.app bundle, .icns icons, Info.plist)
**Confidence:** HIGH

## Summary

This phase addresses professional macOS app distribution for KeyBlast. The goal is to create a proper `.app` bundle that shows the lightning bolt icon in Finder and Dock, following Apple's bundle conventions. This is the macOS equivalent of Phase 11's Windows executable polish.

The standard approach uses **cargo-bundle** (v0.9.0), a cargo subcommand that wraps Rust executables into OS-specific bundles. For macOS, it creates a properly structured `.app` bundle with Contents/MacOS (executable), Contents/Resources (icons), and Contents/Info.plist (metadata). cargo-bundle automatically converts PNG icons to the required `.icns` format.

The existing `assets/icon.ico` contains a 256x256 PNG image that can be extracted and used as the source for ICNS generation. Alternatively, cargo-bundle can work directly with the 256x256 PNG if extracted from the ICO file. The key insight is that cargo-bundle handles format conversion automatically - you provide PNGs at various sizes, and it produces the appropriate bundle format.

**Primary recommendation:** Use `cargo-bundle --release` with `[package.metadata.bundle]` configuration in Cargo.toml. Provide the icon as PNG files at multiple resolutions, and cargo-bundle will create the .icns and complete .app bundle automatically.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| cargo-bundle | 0.9.0 | Create .app bundles from Cargo projects | Official Rust ecosystem tool, handles Info.plist generation, icon conversion, bundle structure automatically |
| iconutil | (macOS built-in) | Convert .iconset folder to .icns | Apple's official tool, ships with Xcode Command Line Tools |
| sips | (macOS built-in) | Resize PNG images to multiple sizes | Apple's built-in image processing, no dependencies |

### Supporting
| Tool | Version | Purpose | When to Use |
|------|---------|---------|-------------|
| ImageMagick | 7.x | Extract PNG from ICO, resize images | If sips not available or more control needed |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| cargo-bundle | Manual .app structure | More control, but must write shell script, handle Info.plist manually |
| cargo-bundle | tauri-bundler | Tauri-specific, overkill for non-Tauri apps |
| sips/iconutil | Online converters | Dependency on external services, not automatable |
| sips/iconutil | icns crate (Rust) | Could automate in build.rs, but adds complexity; macOS tools are simpler |

**Installation:**
```bash
# cargo-bundle (one-time install)
cargo install cargo-bundle

# ImageMagick (optional, for ICO extraction)
brew install imagemagick

# iconutil and sips ship with macOS/Xcode Command Line Tools
```

## Architecture Patterns

### Recommended Project Structure
```
keyblast/
├── Cargo.toml              # Add [package.metadata.bundle] section
├── build.rs                # Existing (Windows resources)
├── assets/
│   ├── icon.png            # Existing (44x44 tray icon)
│   ├── icon-flash.png      # Existing (44x44 flash icon)
│   ├── icon.ico            # Existing (multi-size Windows icon)
│   ├── icon-1024.png       # NEW: High-res source for macOS
│   ├── macos/              # NEW: macOS icon variants
│   │   ├── icon_16x16.png
│   │   ├── icon_16x16@2x.png
│   │   ├── icon_32x32.png
│   │   ├── icon_32x32@2x.png
│   │   ├── icon_128x128.png
│   │   ├── icon_128x128@2x.png
│   │   ├── icon_256x256.png
│   │   ├── icon_256x256@2x.png
│   │   ├── icon_512x512.png
│   │   └── icon_512x512@2x.png
│   └── extra_plist.xml     # NEW: Custom Info.plist keys (optional)
└── target/
    └── release/
        └── bundle/
            └── osx/
                └── KeyBlast.app/    # Generated by cargo-bundle
```

### Pattern 1: cargo-bundle Configuration
**What:** Declare bundle metadata in Cargo.toml
**When to use:** Always for macOS .app bundle generation
**Example:**
```toml
# Source: https://github.com/burtonageo/cargo-bundle
[package.metadata.bundle]
name = "KeyBlast"
identifier = "com.keyblast.app"
icon = [
    "assets/macos/icon_16x16.png",
    "assets/macos/icon_16x16@2x.png",
    "assets/macos/icon_32x32.png",
    "assets/macos/icon_32x32@2x.png",
    "assets/macos/icon_128x128.png",
    "assets/macos/icon_128x128@2x.png",
    "assets/macos/icon_256x256.png",
    "assets/macos/icon_256x256@2x.png",
    "assets/macos/icon_512x512.png",
    "assets/macos/icon_512x512@2x.png",
]
version = "0.1.0"
copyright = "Copyright (c) 2026 KeyBlast"
category = "public.app-category.productivity"
short_description = "A lightweight macro playback application"
osx_minimum_system_version = "10.13"
```

### Pattern 2: Icon Generation Script (macOS)
**What:** Generate all required PNG sizes from high-res source
**When to use:** One-time setup before first bundle
**Example:**
```bash
#!/bin/bash
# Source: Apple iconutil documentation
# generate_icons.sh - Run from project root

SOURCE="assets/icon-1024.png"  # 1024x1024 source image
OUTDIR="assets/macos"

mkdir -p "$OUTDIR"

# Standard sizes (name_WxH.png where actual pixel size matches)
sips -z 16 16     "$SOURCE" --out "$OUTDIR/icon_16x16.png"
sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_16x16@2x.png"
sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_32x32.png"
sips -z 64 64     "$SOURCE" --out "$OUTDIR/icon_32x32@2x.png"
sips -z 128 128   "$SOURCE" --out "$OUTDIR/icon_128x128.png"
sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_128x128@2x.png"
sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_256x256.png"
sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_256x256@2x.png"
sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_512x512.png"
sips -z 1024 1024 "$SOURCE" --out "$OUTDIR/icon_512x512@2x.png"

echo "Generated macOS icon set in $OUTDIR"
```

### Pattern 3: Building the Bundle
**What:** Generate the .app bundle
**When to use:** For distribution
**Example:**
```bash
# Source: https://github.com/burtonageo/cargo-bundle
# Build release binary and create .app bundle
cargo bundle --release

# Output location:
# target/release/bundle/osx/KeyBlast.app/
```

### Pattern 4: Custom Info.plist Keys (optional)
**What:** Add custom keys not supported by cargo-bundle directly
**When to use:** If LSUIElement or other custom keys needed
**Example (assets/extra_plist.xml):**
```xml
<!-- Add to osx_info_plist_exts if needed -->
<key>NSHighResolutionCapable</key>
<true/>
```

**Note on LSUIElement:** The requirements state "icon in Finder/Dock", meaning the app SHOULD appear in the Dock when running. Therefore, LSUIElement should NOT be set (or set to false). cargo-bundle's default behavior (no LSUIElement) is correct for this use case.

### Anti-Patterns to Avoid
- **Using single-size icon:** macOS requires multiple sizes for different contexts (Dock, Finder, Spotlight). A single 256x256 PNG will look blurry in small contexts.
- **Forgetting @2x variants:** Retina displays need 2x resolution variants. Without them, icons appear blurry on high-DPI screens.
- **Setting LSUIElement=true:** This would hide the app from Dock, contradicting MAC-01 requirement.
- **Manual .app structure without automation:** Easy to miss files or get structure wrong. Use cargo-bundle.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| .app bundle structure | Manual mkdir/cp | cargo-bundle | Handles Info.plist, code signing prep, icon conversion |
| PNG to ICNS conversion | Custom converter | cargo-bundle or iconutil | ICNS format is complex (container with multiple images) |
| Icon resizing | Manual resize each | sips script | Tedious, error-prone; sips handles all sizes in one script |
| Info.plist generation | Hand-write XML | cargo-bundle | Many required keys, easy to miss; cargo-bundle populates from Cargo.toml |
| Bundle identifier | Random string | Reverse-DNS format | Apple convention, required for proper macOS integration |

**Key insight:** macOS app bundles look like simple directory structures, but getting all the pieces right (Info.plist keys, icon formats, bundle structure, code resources) is tedious. cargo-bundle handles all of this from Cargo.toml metadata.

## Common Pitfalls

### Pitfall 1: Missing High-Resolution Source Icon
**What goes wrong:** Icons look blurry on Retina displays or in large Finder views.
**Why it happens:** Starting with a small source image (like the existing 44x44 icon.png) and scaling up.
**How to avoid:** Need a 1024x1024 source PNG. The existing icon.ico has 256x256 max, which is insufficient for 512x512@2x.
**Warning signs:** App icon looks pixelated in Finder or Dock on Retina displays.
**Solution for this project:** Extract 256x256 from icon.ico as starting point, but acknowledge the limitation. Ideally, regenerate from original vector/high-res source.

### Pitfall 2: cargo-bundle Not Installed
**What goes wrong:** `cargo bundle` command not found.
**Why it happens:** cargo-bundle is not a built-in cargo command; it's a separately installed subcommand.
**How to avoid:** Run `cargo install cargo-bundle` first.
**Warning signs:** Error message "no such subcommand: bundle".

### Pitfall 3: Missing identifier Field
**What goes wrong:** cargo-bundle refuses to run.
**Why it happens:** `identifier` is REQUIRED in `[package.metadata.bundle]`.
**How to avoid:** Always include `identifier = "com.yourcompany.appname"` in bundle config.
**Warning signs:** Error about missing identifier.

### Pitfall 4: Wrong Icon Naming Convention
**What goes wrong:** cargo-bundle doesn't recognize icons, or iconutil fails.
**Why it happens:** macOS icon naming is strict: `icon_WxH.png` for standard, `icon_WxH@2x.png` for Retina.
**How to avoid:** Follow exact naming: `icon_16x16.png`, `icon_16x16@2x.png`, etc. The @2x file should be 2x the named dimensions.
**Warning signs:** "Failed to generate ICNS" or missing icon in bundle.

### Pitfall 5: Bundle Cache Issues
**What goes wrong:** Changes to Info.plist or icon don't take effect.
**Why it happens:** macOS aggressively caches bundle metadata.
**How to avoid:** After regenerating bundle, run `touch KeyBlast.app` or delete and re-copy to Applications.
**Warning signs:** Old icon shows, or metadata appears stale.

### Pitfall 6: Icon Asset Gap
**What goes wrong:** Existing assets insufficient for macOS bundle.
**Why it happens:** Current assets are: icon.png (44x44), icon-flash.png (44x44), icon.ico (max 256x256).
**How to avoid:** Need to either: (a) extract 256x256 from icon.ico and accept some quality loss, or (b) regenerate from original design source at 1024x1024.
**Warning signs:** macOS icon looks less sharp than Windows icon.

## Code Examples

Verified patterns from official sources:

### Complete Cargo.toml Bundle Section
```toml
# Source: https://github.com/burtonageo/cargo-bundle
[package]
name = "keyblast"
version = "0.1.0"
edition = "2021"
build = "build.rs"
description = "A lightweight macro playback application that injects keystrokes via hotkeys"
license = "MIT"

# ... existing dependencies ...

[package.metadata.bundle]
name = "KeyBlast"
identifier = "com.keyblast.app"
icon = [
    "assets/macos/icon_16x16.png",
    "assets/macos/icon_16x16@2x.png",
    "assets/macos/icon_32x32.png",
    "assets/macos/icon_32x32@2x.png",
    "assets/macos/icon_128x128.png",
    "assets/macos/icon_128x128@2x.png",
    "assets/macos/icon_256x256.png",
    "assets/macos/icon_256x256@2x.png",
    "assets/macos/icon_512x512.png",
    "assets/macos/icon_512x512@2x.png",
]
version = "0.1.0"
copyright = "Copyright (c) 2026 KeyBlast"
category = "public.app-category.productivity"
short_description = "A lightweight macro playback application"
osx_minimum_system_version = "10.13"
```

### Extract 256x256 PNG from ICO
```bash
# Source: ImageMagick documentation
# The ICO file's first layer [0] is the 256x256 PNG
magick assets/icon.ico[0] assets/icon-256.png

# Verify extraction
file assets/icon-256.png
# Should output: PNG image data, 256 x 256
```

### Complete Icon Generation Script
```bash
#!/bin/bash
# generate_macos_icons.sh
# Source: Apple iconutil documentation + sips man page
set -e

# Check for source image
if [ ! -f "assets/icon-256.png" ]; then
    echo "Extracting 256x256 from icon.ico..."
    magick assets/icon.ico[0] assets/icon-256.png
fi

SOURCE="assets/icon-256.png"
OUTDIR="assets/macos"

mkdir -p "$OUTDIR"

echo "Generating macOS icon sizes from $SOURCE..."

# Note: Scaling UP from 256 will cause quality loss for larger sizes
# For best results, start with a 1024x1024 source

# Scaling DOWN (good quality)
sips -z 16 16     "$SOURCE" --out "$OUTDIR/icon_16x16.png"
sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_16x16@2x.png"
sips -z 32 32     "$SOURCE" --out "$OUTDIR/icon_32x32.png"
sips -z 64 64     "$SOURCE" --out "$OUTDIR/icon_32x32@2x.png"
sips -z 128 128   "$SOURCE" --out "$OUTDIR/icon_128x128.png"
sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_128x128@2x.png"
sips -z 256 256   "$SOURCE" --out "$OUTDIR/icon_256x256.png"

# Scaling UP (quality compromise - ideally use 1024x1024 source)
sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_256x256@2x.png"
sips -z 512 512   "$SOURCE" --out "$OUTDIR/icon_512x512.png"
sips -z 1024 1024 "$SOURCE" --out "$OUTDIR/icon_512x512@2x.png"

echo "Generated $(ls -1 $OUTDIR | wc -l | tr -d ' ') icon files in $OUTDIR"
```

### Build and Verify Bundle
```bash
# Install cargo-bundle (one-time)
cargo install cargo-bundle

# Build the bundle
cargo bundle --release

# Verify bundle structure
ls -la target/release/bundle/osx/KeyBlast.app/Contents/
# Should show: Info.plist, MacOS/, Resources/

ls target/release/bundle/osx/KeyBlast.app/Contents/MacOS/
# Should show: keyblast (executable)

ls target/release/bundle/osx/KeyBlast.app/Contents/Resources/
# Should show: keyblast.icns (or similar)

# Test run
open target/release/bundle/osx/KeyBlast.app
```

### Verify Info.plist Contents
```bash
# View generated Info.plist
cat target/release/bundle/osx/KeyBlast.app/Contents/Info.plist

# Check specific key
/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" \
    target/release/bundle/osx/KeyBlast.app/Contents/Info.plist
# Should output: com.keyblast.app
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual .app directory creation | cargo-bundle automation | cargo-bundle 0.6+ | Eliminates manual Info.plist, icon handling |
| Single-size app icons | Multi-size .iconset | Always for Retina | Required for crisp icons on all displays |
| ICO-only cross-platform icons | Platform-specific formats | Always | macOS uses ICNS, Windows uses ICO |

**Deprecated/outdated:**
- **Manual icon embedding in build.rs:** Not needed for macOS; cargo-bundle handles this via metadata
- **32x32 only icons:** Modern macOS needs up to 1024x1024 for Retina displays

## Open Questions

Things that couldn't be fully resolved:

1. **High-resolution source icon availability**
   - What we know: Existing icon.ico max resolution is 256x256. Scaling to 512x512 or 1024x1024 will reduce quality.
   - What's unclear: Whether the original icon design source (vector or high-res PNG) is available.
   - Recommendation: Extract 256x256 from icon.ico and proceed. Accept that 512x512@2x may be slightly less sharp. If quality is unacceptable, source higher-res icon later.

2. **Code signing and notarization**
   - What we know: cargo-bundle creates unsigned bundles. For App Store or Gatekeeper, signing is required.
   - What's unclear: Whether this phase requires code signing (not mentioned in requirements).
   - Recommendation: Phase 14 scope is bundle creation and icon display. Code signing can be a future enhancement if distribution requires it.

3. **App category selection**
   - What we know: `category` field accepts Apple's LSApplicationCategoryType values.
   - What's unclear: Best category for a macro/productivity tool.
   - Recommendation: Use `public.app-category.productivity` or `public.app-category.utilities`.

## Sources

### Primary (HIGH confidence)
- [cargo-bundle GitHub](https://github.com/burtonageo/cargo-bundle) - Configuration options, icon handling, Info.plist generation
- [Apple Bundle Structures](https://developer.apple.com/library/archive/documentation/CoreFoundation/Conceptual/CFBundles/BundleTypes/BundleTypes.html) - Official macOS bundle structure documentation
- [Apple Info.plist Key Reference](https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Introduction/Introduction.html) - Required and optional Info.plist keys

### Secondary (MEDIUM confidence)
- [Creating .icns files guide](https://gist.github.com/jamieweavis/b4c394607641e1280d447deed5fc85fc) - Icon sizes and naming conventions
- [Tom Mewett: Making a Mac Application Bundle](https://tmewett.com/making-macos-bundle-info-plist/) - Manual bundle creation reference

### Tertiary (LOW confidence)
- WebSearch results for cargo-bundle version info - Confirmed v0.9.0 is latest

## Metadata

**Confidence breakdown:**
- cargo-bundle usage: HIGH - Official tool, well-documented
- Icon format requirements: HIGH - Apple documentation is authoritative
- Bundle structure: HIGH - Apple documentation is authoritative
- Icon generation with sips: HIGH - macOS built-in tool, well-documented

**Research date:** 2026-01-17
**Valid until:** 2026-04-17 (90 days - macOS bundle format is stable)

---

## Implementation Checklist for Planner

Based on this research, Phase 14 implementation requires:

1. [ ] Install cargo-bundle: `cargo install cargo-bundle`
2. [ ] Extract 256x256 PNG from existing icon.ico: `magick assets/icon.ico[0] assets/icon-256.png`
3. [ ] Create icon generation script and generate all sizes in assets/macos/
4. [ ] Add `[package.metadata.bundle]` section to Cargo.toml
5. [ ] Run `cargo bundle --release` to generate .app bundle
6. [ ] Verify bundle structure (Contents/MacOS, Contents/Resources, Contents/Info.plist)
7. [ ] Test icon appearance in Finder (list view, icon view, Get Info)
8. [ ] Test icon appearance in Dock when app is running
9. [ ] Verify app launches correctly from .app bundle
