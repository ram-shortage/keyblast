---
phase: 06-platform-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/autostart.rs
  - src/tray.rs
  - src/main.rs
autonomous: true

must_haves:
  truths:
    - "User can enable auto-start at login from tray menu"
    - "User can disable auto-start at login from tray menu"
    - "Auto-start toggle state reflects actual system state"
  artifacts:
    - path: "src/autostart.rs"
      provides: "Auto-launch management functions"
      exports: ["create_auto_launch", "is_auto_start_enabled", "set_auto_start"]
    - path: "src/tray.rs"
      provides: "Auto-start menu item"
      contains: "Start at Login"
    - path: "Cargo.toml"
      provides: "auto-launch dependency"
      contains: "auto-launch"
  key_links:
    - from: "src/main.rs"
      to: "src/autostart.rs"
      via: "menu event handler"
      pattern: "autostart::(is_auto_start_enabled|set_auto_start)"
    - from: "src/tray.rs"
      to: "auto_start menu ID"
      via: "MenuIds struct"
      pattern: "auto_start.*MenuId"
---

<objective>
Add auto-start at login functionality (PLAT-03).

Purpose: Allow users to have KeyBlast start automatically when they log in, which is essential for a tray-resident utility that should "just be there."

Output: New autostart module with enable/disable functions, tray menu item with checkbox, and wired event handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/6-platform-polish/06-RESEARCH.md
@src/main.rs
@src/tray.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-launch crate and create autostart module</name>
  <files>Cargo.toml, src/autostart.rs</files>
  <action>
1. Add `auto-launch = "0.6"` to Cargo.toml dependencies.

2. Create `src/autostart.rs` with:
   - `create_auto_launch()` function that builds AutoLaunch with:
     - app_name: "KeyBlast"
     - app_path: from `std::env::current_exe()`
     - MacOSLaunchMode::LaunchAgent for macOS
     - Optional `--minimized` arg (for future use)
   - `is_auto_start_enabled() -> bool` that checks current state
   - `set_auto_start(enabled: bool) -> Result<(), auto_launch::Error>` to enable/disable

Pattern from research:
```rust
use auto_launch::{AutoLaunch, AutoLaunchBuilder};

#[cfg(target_os = "macos")]
use auto_launch::MacOSLaunchMode;

pub fn create_auto_launch() -> Result<AutoLaunch, auto_launch::Error> {
    let app_name = "KeyBlast";
    let app_path = std::env::current_exe()
        .map_err(|e| auto_launch::Error::Io(e))?
        .to_string_lossy()
        .to_string();

    #[cfg(target_os = "macos")]
    {
        AutoLaunchBuilder::new()
            .set_app_name(app_name)
            .set_app_path(&app_path)
            .set_use_launch_agent(true)
            .build()
    }

    #[cfg(not(target_os = "macos"))]
    {
        AutoLaunchBuilder::new()
            .set_app_name(app_name)
            .set_app_path(&app_path)
            .build()
    }
}

pub fn is_auto_start_enabled() -> bool {
    create_auto_launch()
        .map(|al| al.is_enabled().unwrap_or(false))
        .unwrap_or(false)
}

pub fn set_auto_start(enabled: bool) -> Result<(), auto_launch::Error> {
    let auto_launch = create_auto_launch()?;
    if enabled {
        auto_launch.enable()
    } else {
        auto_launch.disable()
    }
}
```
  </action>
  <verify>
    `cargo check` compiles without errors.
    `cargo test` passes (existing tests).
  </verify>
  <done>autostart.rs exists with create_auto_launch, is_auto_start_enabled, and set_auto_start functions.</done>
</task>

<task type="auto">
  <name>Task 2: Add auto-start toggle to tray menu</name>
  <files>src/tray.rs, src/main.rs</files>
  <action>
1. In `src/tray.rs`:
   - Add `auto_start: muda::MenuId` to `MenuIds` struct
   - In `build_menu()`, add a CheckMenuItem for "Start at Login" after the separator following "Import Macros":
     - Query initial state via `crate::autostart::is_auto_start_enabled()`
     - Create CheckMenuItem with that initial checked state
     - Add to menu before the final separator (before Quit)
   - Return the auto_start MenuId in MenuIds

2. In `src/main.rs`:
   - Add `mod autostart;` to module declarations
   - Initialize `auto_start: muda::MenuId::new("")` in KeyBlastApp::new()
   - In `about_to_wait()`, add handler for auto_start menu event:
     - Get current state via `autostart::is_auto_start_enabled()`
     - Toggle via `autostart::set_auto_start(!currently_enabled)`
     - On success, update CheckMenuItem state
     - On error, print error message

Pattern for menu item:
```rust
// In build_menu after import_item
let auto_start_enabled = crate::autostart::is_auto_start_enabled();
let auto_start_item = CheckMenuItem::new(
    "Start at Login",
    true,
    auto_start_enabled,
    None::<Accelerator>,
);
let auto_start_id = auto_start_item.id().clone();
menu.append(&auto_start_item).expect("Failed to add auto-start item");
```

Pattern for event handler:
```rust
} else if event.id == self.menu_ids.auto_start {
    let currently_enabled = autostart::is_auto_start_enabled();
    match autostart::set_auto_start(!currently_enabled) {
        Ok(()) => {
            println!("Auto-start {}", if !currently_enabled { "enabled" } else { "disabled" });
            // Update checkbox state in menu
            for item in self.menu.items() {
                if let muda::MenuItemKind::Check(check_item) = item {
                    if check_item.id() == &self.menu_ids.auto_start {
                        check_item.set_checked(!currently_enabled);
                        break;
                    }
                }
            }
        }
        Err(e) => {
            eprintln!("Failed to toggle auto-start: {}", e);
        }
    }
}
```
  </action>
  <verify>
    `cargo build --release` succeeds.
    Run app, right-click tray, see "Start at Login" checkbox menu item.
    Click to toggle - console shows enable/disable message.
    On macOS: Check ~/Library/LaunchAgents/ for plist file when enabled.
    On Windows: Check registry HKCU\Software\Microsoft\Windows\CurrentVersion\Run when enabled.
  </verify>
  <done>Tray menu has "Start at Login" checkbox that toggles auto-start and persists across app restarts.</done>
</task>

</tasks>

<verification>
1. `cargo build --release` completes without errors
2. Run KeyBlast, right-click tray icon
3. "Start at Login" checkbox appears in menu
4. Toggle the checkbox - state changes
5. Quit and restart app - checkbox reflects persisted state
6. On macOS: `ls ~/Library/LaunchAgents/ | grep -i keyblast` shows plist when enabled
7. On Windows: `reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Run"` shows KeyBlast when enabled
</verification>

<success_criteria>
- PLAT-03 complete: User can enable auto-start at login
- Auto-start toggle appears in tray menu
- Toggle state persists and reflects actual system state
- Works on both macOS (LaunchAgent) and Windows (Registry)
</success_criteria>

<output>
After completion, create `.planning/phases/6-platform-polish/06-01-SUMMARY.md`
</output>
