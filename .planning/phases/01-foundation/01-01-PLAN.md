---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/app.rs
  - src/tray.rs
  - assets/icon.png
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can see KeyBlast icon in system tray"
    - "User can right-click tray icon to see menu"
    - "User can toggle Enable/Disable and see checkmark state change"
    - "User can quit the app from the menu"
  artifacts:
    - path: "Cargo.toml"
      provides: "Rust project manifest with dependencies"
      contains: "tray-icon"
    - path: "src/main.rs"
      provides: "Entry point with event loop"
      exports: ["main"]
    - path: "src/app.rs"
      provides: "Application state management"
      contains: "struct AppState"
    - path: "src/tray.rs"
      provides: "Tray icon and menu setup"
      contains: "fn build_menu"
  key_links:
    - from: "src/main.rs"
      to: "src/tray.rs"
      via: "tray setup call"
      pattern: "tray::"
    - from: "src/main.rs"
      to: "src/app.rs"
      via: "state management"
      pattern: "AppState"
    - from: "src/tray.rs"
      to: "muda menu"
      via: "menu item events"
      pattern: "MenuEvent"
---

<objective>
Create a Rust system tray application with enable/disable toggle and quit functionality.

Purpose: Establish the foundational cross-platform tray presence that all future phases build upon.
Output: Working system tray app with menu that responds to user interactions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Rust project with dependencies</name>
  <files>Cargo.toml, src/main.rs</files>
  <action>
Create a new Rust binary project using cargo init.

Configure Cargo.toml with:
- Package name: keyblast
- Version: 0.1.0
- Edition: 2021
- Dependencies:
  - tray-icon = "0.21" (system tray)
  - muda = "0.17" (menus - same version compatibility with tray-icon)
  - image = "0.25" (for loading PNG icon)

Create minimal src/main.rs that compiles (just fn main with println for now).

Run `cargo build` to verify dependencies resolve and project compiles.
  </action>
  <verify>
- `cargo build` succeeds without errors
- Cargo.lock is generated with tray-icon, muda, image dependencies
  </verify>
  <done>Rust project initialized with correct dependencies and builds successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Implement system tray with menu</name>
  <files>src/main.rs, src/app.rs, src/tray.rs, assets/icon.png</files>
  <action>
Create assets/ directory and add a simple 32x32 PNG icon. Use a placeholder icon (a solid color square is fine for now - can be replaced later).

Create src/app.rs:
```rust
pub struct AppState {
    pub enabled: bool,
}

impl AppState {
    pub fn new() -> Self {
        Self { enabled: true }
    }

    pub fn toggle(&mut self) {
        self.enabled = !self.enabled;
    }
}
```

Create src/tray.rs:
- Function to load icon from assets/icon.png using the image crate
- Function to build menu with:
  - "Enable/Disable" item (checkable, shows checkmark when enabled)
  - Separator
  - "Quit" item
- Use muda crate for menu construction
- Return the tray icon and menu item IDs for event handling

Update src/main.rs:
- Import app and tray modules
- Initialize AppState
- Create tray icon with menu
- Run event loop that:
  - Listens for MenuEvent using muda::MenuEvent::receiver()
  - On Enable/Disable click: toggle AppState.enabled, rebuild menu to update checkmark
  - On Quit click: exit process
- Use a simple loop with recv() - no async needed

IMPORTANT: The tray-icon and muda crates require running on the main thread. Use a simple blocking event loop pattern, not async.

IMPORTANT: On macOS, must call `tray_icon::TrayIconBuilder` after the application is running. The pattern is:
1. Load icon
2. Build menu
3. Create tray icon with menu
4. Enter event loop

For cross-platform compatibility, use conditional compilation (#[cfg(target_os = "...")]) only if absolutely necessary. The crates should handle platform differences internally.
  </action>
  <verify>
- `cargo build` succeeds
- `cargo run` shows icon in system tray
- Right-click shows menu with "Enable/Disable" and "Quit"
- Clicking "Enable/Disable" toggles the checkmark
- Clicking "Quit" closes the application
  </verify>
  <done>System tray application running with functional enable/disable toggle and quit menu.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>System tray application with enable/disable toggle and quit functionality</what-built>
  <how-to-verify>
1. Run `cargo run` from the keyblast directory
2. Look for the app icon in your system tray (menu bar on macOS, system tray on Windows)
3. Right-click (or click on macOS) the tray icon
4. Verify menu shows:
   - "Enable" or "Disable" item (may have checkmark)
   - A separator line
   - "Quit" item
5. Click "Enable/Disable" multiple times - verify the checkmark toggles
6. Click "Quit" - verify the application closes

Expected behavior:
- Icon visible in system tray
- Menu appears on right-click
- Toggle state changes visually
- Quit terminates the process
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 requirements verification:

TRAY-01 (User can see app in system tray with menu):
- App icon appears in system tray
- Right-click reveals menu

TRAY-02 (User can enable/disable all macros via toggle):
- Menu contains Enable/Disable toggle item
- Toggle state persists visually (checkmark changes)
- State stored in AppState.enabled for future phases to use
</verification>

<success_criteria>
1. App icon visible in system tray on macOS (test platform)
2. Right-click menu shows Enable/Disable toggle and Quit option
3. Toggle state changes visually when clicked (checkmark on/off)
4. Quit menu item terminates the application
5. Code compiles without warnings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
