---
phase: 04-configuration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [src/main.rs]
autonomous: false

must_haves:
  truths:
    - "App loads macros from config file at startup"
    - "Loaded macros are registered as hotkeys"
    - "Triggering a loaded hotkey injects the configured text"
    - "If no config exists, app creates default config with example macro"
  artifacts:
    - path: "src/main.rs"
      provides: "Config loading and macro registration at startup"
      contains: "load_config"
  key_links:
    - from: "src/main.rs"
      to: "src/config.rs"
      via: "load_config call in resumed()"
      pattern: "config::load_config"
    - from: "KeyBlastApp"
      to: "Config"
      via: "stored config field"
      pattern: "config: Option<config::Config>"
---

<objective>
Wire config loading into app startup and replace hardcoded test macro with config-loaded macros.

Purpose: Complete the persistence story - macros defined in TOML are loaded and work at app startup.
Output: Working end-to-end flow from config.toml to keystroke injection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/4-configuration/04-01-SUMMARY.md
@src/config.rs
@src/main.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire config loading into app startup</name>
  <files>src/main.rs</files>
  <action>
Modify src/main.rs:

1. **Add config field to KeyBlastApp**:
   - Add `config: Option<config::Config>` field
   - Add `macros: std::collections::HashMap<u32, config::MacroDefinition>` to map hotkey_id -> macro

2. **Load config in resumed()**:
   - Call `config::load_config()` at startup
   - On success, store in self.config
   - On error, log warning and continue with empty config

3. **Create default config if none exists**:
   - If load_config returns default (empty macros), create a starter macro:
     - name: "example"
     - hotkey: "ctrl+shift+k"
     - text: "Hello from KeyBlast!{Enter}"
     - delay_ms: 0
   - Save this default config so user has a template to edit

4. **Register macros from config**:
   - For each macro in config.macros:
     - Parse hotkey string with config::parse_hotkey_string
     - Register with hotkey_manager.register(hotkey, macro.name.clone())
     - Store in self.macros HashMap keyed by hotkey.id()
     - Log success/failure for each

5. **Remove hardcoded test macro registration** (lines 91-116 in current main.rs)

6. **Update user_event handler**:
   - When hotkey triggers, look up macro in self.macros by hotkey_id
   - Use macro.text and macro.delay_ms instead of hardcoded values
   - Remove trigger_count and instant/slow alternation (use macro's delay_ms)
  </action>
  <verify>
`cargo build --release` succeeds.
Run app, check console output shows:
- Config loaded from path (or default created)
- Macro registered with hotkey
  </verify>
  <done>
- KeyBlastApp loads config at startup
- Macros from config are registered as hotkeys
- Config file created with example macro if none existed
- Hardcoded test macro removed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>End-to-end config loading and macro execution</what-built>
  <how-to-verify>
1. Delete any existing config: `rm -rf ~/Library/Application\ Support/keyblast/`
2. Run the app: `cargo run --release`
3. Verify console shows: "Created default config at..." and "Registered macro: example"
4. Open a text editor (TextEdit, VS Code, etc.)
5. Press Ctrl+Shift+K
6. Verify "Hello from KeyBlast!" appears followed by newline

7. Edit the config file:
   - Open ~/Library/Application Support/keyblast/config.toml
   - Change text to "Custom macro!{Enter}"
   - Save

8. Restart the app (Cmd+Q tray menu, then `cargo run --release`)
9. Press Ctrl+Shift+K
10. Verify "Custom macro!" appears (proving config was reloaded)
  </how-to-verify>
  <resume-signal>Type "approved" if macros persist across restart, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- App starts and loads config without errors
- Hotkeys from config are registered
- Pressing configured hotkey types the configured text
- Edited config is reflected after app restart
</verification>

<success_criteria>
- CONF-01 satisfied: User's macros persist across app restarts
- Config file is human-readable TOML (success criteria 2)
- Config loads automatically at startup (success criteria 3)
- Default config created with example macro if no config exists
</success_criteria>

<output>
After completion, create `.planning/phases/4-configuration/04-02-SUMMARY.md`
</output>
