---
phase: 12-error-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/notification.rs
  - src/main.rs
  - src/permission.rs
autonomous: false

must_haves:
  truths:
    - "User sees tray notification when keystroke injection fails"
    - "User sees tray notification when macOS Accessibility permission is missing"
    - "User sees tray notification when Windows injection is blocked (generic error)"
    - "Notifications do not spam when multiple failures occur rapidly"
  artifacts:
    - path: "src/notification.rs"
      provides: "Notification abstraction module"
      exports: ["show_error", "NotificationSeverity"]
      min_lines: 40
    - path: "Cargo.toml"
      provides: "notify-rust dependency"
      contains: "notify-rust"
  key_links:
    - from: "src/main.rs"
      to: "src/notification.rs"
      via: "show_error calls at injection failure sites"
      pattern: "notification::show_error"
    - from: "src/permission.rs"
      to: "src/notification.rs"
      via: "show_error call on permission denial"
      pattern: "notification::show_error"
---

<objective>
Add user-visible tray notifications when keystroke injection fails or permission issues occur.

Purpose: Users currently see no feedback when macros silently fail (permission denied, injection blocked). This phase surfaces errors via OS toast notifications so users know something went wrong and can take action.

Output: Working notification system that shows tray notifications for injection failures (5s auto-dismiss) and permission errors (persistent until dismissed).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-error-notifications/12-RESEARCH.md
@src/main.rs
@src/permission.rs
@src/injection.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notification module with notify-rust</name>
  <files>
    - Cargo.toml
    - src/notification.rs
  </files>
  <action>
1. Add `notify-rust = "4"` to Cargo.toml dependencies section

2. Create `src/notification.rs` with:

```rust
//! User-facing error notifications for KeyBlast.
//!
//! Provides cross-platform toast notifications for error conditions.
//! Uses notify-rust to abstract macOS/Windows/Linux differences.

use notify_rust::{Notification, Timeout};
use std::sync::atomic::{AtomicU64, Ordering};
use std::time::{SystemTime, UNIX_EPOCH};

/// Minimum interval between notifications to prevent spam (3 seconds)
const NOTIFICATION_DEBOUNCE_MS: u64 = 3000;

/// Last notification timestamp for debouncing
static LAST_NOTIFICATION: AtomicU64 = AtomicU64::new(0);

/// Severity levels for error notifications.
#[derive(Debug, Clone, Copy)]
pub enum NotificationSeverity {
    /// Permission issues - persistent notification, user action required
    Permission,
    /// Injection failed - transient notification, informational
    InjectionFailed,
}

impl NotificationSeverity {
    fn timeout(&self) -> Timeout {
        match self {
            // Note: macOS ignores timeout - system controls duration
            NotificationSeverity::Permission => Timeout::Never,
            NotificationSeverity::InjectionFailed => Timeout::Milliseconds(5000),
        }
    }
}

/// Show an error notification to the user.
///
/// Notifications are debounced to prevent spam when multiple failures occur rapidly.
/// Permission errors bypass debouncing since they are critical.
///
/// # Arguments
///
/// * `title` - Notification title (e.g., "KeyBlast")
/// * `message` - Error message to display
/// * `severity` - Determines notification timeout behavior
pub fn show_error(title: &str, message: &str, severity: NotificationSeverity) {
    // Permission errors always show (critical)
    // Other errors are debounced
    if !matches!(severity, NotificationSeverity::Permission) {
        let now = SystemTime::now()
            .duration_since(UNIX_EPOCH)
            .map(|d| d.as_millis() as u64)
            .unwrap_or(0);

        let last = LAST_NOTIFICATION.load(Ordering::Relaxed);
        if now.saturating_sub(last) < NOTIFICATION_DEBOUNCE_MS {
            // Too soon since last notification, skip
            return;
        }
        LAST_NOTIFICATION.store(now, Ordering::Relaxed);
    }

    let result = Notification::new()
        .summary(title)
        .body(message)
        .appname("KeyBlast")
        .timeout(severity.timeout())
        .show();

    if let Err(e) = result {
        // Fallback to logging if notification fails
        tracing::error!("Notification failed: {} - {} - {}", title, message, e);
    }
}

/// Get platform-specific permission error message.
pub fn permission_error_message() -> &'static str {
    #[cfg(target_os = "macos")]
    {
        "Accessibility permission required.\n\nGo to System Settings > Privacy & Security > Accessibility to enable KeyBlast."
    }
    #[cfg(target_os = "windows")]
    {
        "Injection may be blocked.\n\nTry running KeyBlast as Administrator for elevated applications."
    }
    #[cfg(not(any(target_os = "macos", target_os = "windows")))]
    {
        "Permission denied for keystroke injection."
    }
}
```

3. Add `mod notification;` to main.rs after the existing mod declarations (after `mod tray;`)
  </action>
  <verify>
    - `cargo check` compiles without errors
    - `grep -n "notify-rust" Cargo.toml` shows dependency
    - `grep -n "mod notification" src/main.rs` shows module declaration
  </verify>
  <done>
    - notification.rs exists with show_error function and NotificationSeverity enum
    - notify-rust dependency added to Cargo.toml
    - Module declared in main.rs
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications at error sites</name>
  <files>
    - src/main.rs
    - src/permission.rs
  </files>
  <action>
1. In `src/main.rs`, add notification calls at injection failure sites:

   a. In the `about_to_wait` method, after `eprintln!("Failed to prepare injection: {}", e);` (~line 509):
   ```rust
   notification::show_error(
       "KeyBlast",
       &format!("Failed to prepare injection: {}", e),
       notification::NotificationSeverity::InjectionFailed,
   );
   ```

   b. After `eprintln!("Injection error: {}", e);` (~line 517):
   ```rust
   notification::show_error(
       "KeyBlast",
       "Macro injection failed",
       notification::NotificationSeverity::InjectionFailed,
   );
   ```

   c. In the `user_event` method, after `eprintln!("Injection failed: {}", e);` (~line 468) in the fast-path sync execution:
   ```rust
   notification::show_error(
       "KeyBlast",
       "Macro injection failed",
       notification::NotificationSeverity::InjectionFailed,
   );
   ```

   d. After `eprintln!("Injection failed: {}", e);` (~line 631) in the run-from-menu fast-path:
   ```rust
   notification::show_error(
       "KeyBlast",
       "Macro injection failed",
       notification::NotificationSeverity::InjectionFailed,
   );
   ```

   e. In the `resumed` method, after `error!("Failed to initialize keystroke injector: {}", e);` (~line 276):
   ```rust
   notification::show_error(
       "KeyBlast",
       notification::permission_error_message(),
       notification::NotificationSeverity::Permission,
   );
   ```

2. In `src/permission.rs`, add notification on macOS permission denial:

   a. Add at top of file:
   ```rust
   use crate::notification;
   ```

   b. In `check_accessibility_permission()` macOS implementation, after `print_accessibility_guidance();` but before the closing brace:
   ```rust
   notification::show_error(
       "KeyBlast - Permission Required",
       notification::permission_error_message(),
       notification::NotificationSeverity::Permission,
   );
   ```

Note: Keep all existing `eprintln!` and `error!` calls - notifications supplement logging, don't replace it.
  </action>
  <verify>
    - `cargo build --release` compiles without errors
    - `cargo test` passes all tests
    - `grep -c "notification::show_error" src/main.rs` returns at least 4 matches
    - `grep -c "notification::show_error" src/permission.rs` returns 1 match
  </verify>
  <done>
    - Notifications shown on keystroke injection failures (all paths)
    - Notifications shown on permission issues (macOS Accessibility, injector init failure)
    - Existing logging preserved
    - Debouncing prevents notification spam on rapid failures
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Error notification system that shows OS toast notifications when macro injection fails or permissions are missing</what-built>
  <how-to-verify>
    1. Build and run KeyBlast: `cargo run --release`

    2. Test permission notification (macOS only):
       a. If KeyBlast doesn't have Accessibility permission, you should see a toast notification
       b. The notification should mention "System Settings > Privacy & Security"

    3. Test injection failure notification:
       a. Create a macro and trigger it (Ctrl+Shift+K by default)
       b. If injection succeeds, no notification (expected)
       c. To force a failure (macOS): Remove KeyBlast from Accessibility permissions, restart app
       d. To force a failure (Windows): Try running macro into an elevated window while KeyBlast runs unelevated
       e. When injection fails, you should see a toast notification

    4. Test debouncing:
       a. Trigger the same failure multiple times rapidly
       b. You should NOT see a flood of notifications (only ~1 per 3 seconds)

    5. Verify notification appearance:
       - On macOS: Notification appears in Notification Center
       - On Windows: Toast notification appears in notification area
       - Title should be "KeyBlast" or "KeyBlast - Permission Required"
       - Body should describe the error

    Note: On macOS during development, notifications may not appear if running from target/debug.
    Use `cargo install --path .` and run the installed binary if notifications don't show.
  </how-to-verify>
  <resume-signal>Type "approved" if notifications work correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
- `cargo build --release` succeeds
- `cargo test` passes all tests
- Notification appears when injection fails
- Notification appears when permission denied (macOS)
- Notifications are debounced (no spam on rapid failures)
- Existing logging still works (`cargo run 2>&1 | grep -i error` shows errors)
</verification>

<success_criteria>
- ERR-01: User receives tray notification when keystroke injection fails
- ERR-02: User receives tray notification when permission issue occurs
- No regression in existing functionality
- Debouncing prevents notification spam
</success_criteria>

<output>
After completion, create `.planning/phases/12-error-notifications/12-01-SUMMARY.md`
</output>
