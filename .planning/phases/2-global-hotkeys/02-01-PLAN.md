---
phase: 02-global-hotkeys
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - src/main.rs
  - src/hotkey.rs
  - src/app.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Global hotkey triggers callback from any focused application"
    - "Hotkey events are processed in the winit event loop"
    - "A test hotkey (Ctrl+Shift+K) can be registered and fires"
  artifacts:
    - path: "src/hotkey.rs"
      provides: "HotkeyManager with registration and event handling"
      exports: ["HotkeyManager", "HotkeyBinding"]
    - path: "src/main.rs"
      provides: "Event loop with custom AppEvent type"
      contains: "EventLoop::<AppEvent>::with_user_event"
  key_links:
    - from: "src/main.rs"
      to: "src/hotkey.rs"
      via: "HotkeyManager created in resumed()"
      pattern: "HotkeyManager::new"
    - from: "GlobalHotKeyEvent::set_event_handler"
      to: "EventLoopProxy"
      via: "Forwards hotkey events to winit loop"
      pattern: "proxy.send_event"
---

<objective>
Integrate global-hotkey crate with existing winit event loop to enable hotkey registration that works from any application.

Purpose: Foundation for HKEY-01 - users need hotkeys that fire regardless of which app is focused
Output: Working hotkey system with test registration (Ctrl+Shift+K prints to console)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/2-global-hotkeys/02-RESEARCH.md
@src/main.rs
@src/app.rs
@src/tray.rs
@Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global-hotkey dependency and create hotkey module</name>
  <files>Cargo.toml, src/hotkey.rs</files>
  <action>
1. Add global-hotkey 0.7 to Cargo.toml dependencies

2. Create src/hotkey.rs with:
   - HotkeyBinding struct: { hotkey: HotKey, macro_id: String }
   - HotkeyManager struct: { manager: GlobalHotKeyManager, bindings: HashMap<u32, HotkeyBinding> }
   - HotkeyManager::new() -> Self (creates GlobalHotKeyManager)
   - HotkeyManager::register(&mut self, hotkey: HotKey, macro_id: String) -> Result<(), global_hotkey::Error>
   - HotkeyManager::get_macro_id(&self, hotkey_id: u32) -> Option<&str>

Keep it simple - no conflict detection yet, just basic registration.
  </action>
  <verify>cargo check passes with no errors</verify>
  <done>global-hotkey in Cargo.toml, src/hotkey.rs compiles with HotkeyManager struct</done>
</task>

<task type="auto">
  <name>Task 2: Update event loop to support custom events</name>
  <files>src/main.rs, src/app.rs</files>
  <action>
1. In main.rs, add AppEvent enum:
   ```rust
   #[derive(Debug)]
   enum AppEvent {
       HotKey(GlobalHotKeyEvent),
       // Menu events still use MenuEvent::receiver()
   }
   ```

2. Change EventLoop::new() to EventLoop::<AppEvent>::with_user_event().build()

3. Before event loop runs, set up GlobalHotKeyEvent handler:
   ```rust
   let proxy = event_loop.create_proxy();
   GlobalHotKeyEvent::set_event_handler(Some(move |event| {
       let _ = proxy.send_event(AppEvent::HotKey(event));
   }));
   ```

4. Update ApplicationHandler impl to ApplicationHandler<AppEvent>

5. Add user_event() method to handle AppEvent::HotKey - for now just println! the hotkey ID

6. In KeyBlastApp struct, add hotkey_manager: Option<HotkeyManager>

7. In resumed(), after tray icon creation, create HotkeyManager and register a test hotkey:
   Ctrl+Shift+K (Modifiers::CONTROL | Modifiers::SHIFT, Code::KeyK)
   Use macro_id "test" for now
  </action>
  <verify>cargo build succeeds, app launches with tray icon visible</verify>
  <done>Event loop accepts custom AppEvent, HotkeyManager initialized in resumed()</done>
</task>

<task type="auto">
  <name>Task 3: Verify hotkey triggers from any application</name>
  <files>src/main.rs</files>
  <action>
1. In user_event() handler, when HotKeyState::Pressed is received:
   - Look up macro_id from hotkey_manager
   - Print "Hotkey triggered: {macro_id}" to console

2. Test manually:
   - Run the app with cargo run
   - Switch to another application (e.g., Terminal, browser)
   - Press Ctrl+Shift+K
   - Verify "Hotkey triggered: test" appears in the KeyBlast console output

3. Add a println! in resumed() showing which hotkey was registered:
   "Registered test hotkey: Ctrl+Shift+K"
  </action>
  <verify>cargo run, then press Ctrl+Shift+K from any app - console shows "Hotkey triggered: test"</verify>
  <done>Hotkey fires from any focused application, console confirms trigger</done>
</task>

</tasks>

<verification>
1. cargo build --release succeeds
2. App runs and shows tray icon
3. Console shows "Registered test hotkey: Ctrl+Shift+K" on startup
4. Pressing Ctrl+Shift+K from any application prints "Hotkey triggered: test"
5. Tray menu still works (Enable toggle, Quit)
</verification>

<success_criteria>
- Global hotkey (Ctrl+Shift+K) fires callback from any focused application
- Hotkey events flow through winit event loop via AppEvent
- HotkeyManager tracks registered hotkeys with macro IDs
- Existing tray functionality unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/2-global-hotkeys/02-01-SUMMARY.md`
</output>
