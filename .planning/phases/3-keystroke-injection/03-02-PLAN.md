---
phase: 03-keystroke-injection
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [src/main.rs]
autonomous: false

must_haves:
  truths:
    - "Hotkey trigger causes text to be typed into focused application"
    - "Special keys in macro sequence work (Enter, Tab, etc.)"
    - "Keystroke delay is configurable per macro"
    - "macOS prompts for Accessibility permission if not granted"
    - "Injection respects enabled/disabled state"
  artifacts:
    - path: "src/main.rs"
      provides: "Integrated hotkey-to-injection pipeline"
      contains: "KeystrokeInjector"
  key_links:
    - from: "src/main.rs"
      to: "src/injection.rs"
      via: "KeystrokeInjector usage in user_event handler"
      pattern: "injector\\.(type_text|execute_sequence)"
    - from: "src/main.rs"
      to: "src/permission.rs"
      via: "check_accessibility_permission at startup"
      pattern: "check_accessibility_permission"
---

<objective>
Wire keystroke injection into the main event loop so hotkey triggers actually type text into the focused application.

Purpose: Complete the core macro playback flow - user presses hotkey, text appears in focused app.
Output: Working end-to-end keystroke injection triggered by Ctrl+Shift+K test hotkey.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/3-keystroke-injection/03-RESEARCH.md
@.planning/phases/3-keystroke-injection/03-01-SUMMARY.md

Reference files:
@src/main.rs (current event loop)
@src/injection.rs (from Plan 01)
@src/permission.rs (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate injection into event loop</name>
  <files>src/main.rs</files>
  <action>
Modify src/main.rs to wire up keystroke injection:

1. **Add module declarations** at top:
   ```rust
   mod injection;
   mod permission;
   ```

2. **Add KeystrokeInjector to KeyBlastApp struct**:
   ```rust
   injector: Option<injection::KeystrokeInjector>,
   ```
   Initialize as None in new().

3. **Check permission and create injector in resumed()**:
   After tray icon creation, before hotkey manager:
   ```rust
   // Check accessibility permission (macOS)
   if !permission::check_accessibility_permission() {
       eprintln!("Warning: Accessibility permission not granted. Keystroke injection may not work.");
       eprintln!("Grant permission in System Preferences > Privacy & Security > Accessibility");
   }

   // Initialize keystroke injector
   match injection::KeystrokeInjector::new() {
       Ok(inj) => {
           println!("Keystroke injector initialized");
           self.injector = Some(inj);
       }
       Err(e) => {
           eprintln!("Failed to initialize keystroke injector: {}", e);
       }
   }
   ```

4. **Define test macro data**:
   Create a test macro sequence to demonstrate functionality:
   ```rust
   let test_macro = "Hello from KeyBlast!{Enter}";
   let test_delay_ms: u64 = 0;  // Instant typing
   ```

5. **Update user_event handler** to inject text when hotkey triggers:
   In the HotKey match arm, when state is Pressed:
   - Check if self.state.enabled (respect enable/disable toggle)
   - If enabled and injector exists:
     - Parse the test macro with `injection::parse_macro_sequence(test_macro)`
     - Call `injector.execute_sequence(&segments, test_delay_ms)`
     - Log result (success or error)
   - If disabled: Log "Macros disabled, ignoring hotkey"

Use `if let Some(ref mut injector) = self.injector` to get mutable access.
  </action>
  <verify>
`cargo build --release` succeeds.
  </verify>
  <done>
main.rs compiles with injection integration. KeystrokeInjector initialized at startup, hotkey handler calls execute_sequence().
  </done>
</task>

<task type="auto">
  <name>Task 2: Test end-to-end injection flow</name>
  <files>src/main.rs</files>
  <action>
Update the test macro in main.rs to demonstrate all requirements:

1. **Change test macro to include special keys**:
   ```rust
   let test_macro = "KeyBlast test:{Enter}Line 2{Tab}tabbed{Enter}";
   ```
   This tests: plain text, Enter key, Tab key, multiple segments.

2. **Add a second test macro with delay** (for testing INJT-03):
   When the hotkey triggers twice in a row, alternate between:
   - First trigger: instant (0ms delay)
   - Second trigger: slow (20ms delay per keystroke)

   Add a simple toggle in AppState or track trigger count to alternate.
   Log which mode is active: "Injecting (instant)" vs "Injecting (slow mode)"

3. **Improve logging** to show what's happening:
   - Log when injection starts: "Injecting macro: {macro_text}"
   - Log on success: "Injection complete"
   - Log on error: "Injection failed: {error}"
  </action>
  <verify>
Run `cargo run` and:
1. Open a text editor (TextEdit, VS Code, Notes)
2. Focus on the text input area
3. Press Ctrl+Shift+K
4. Verify "KeyBlast test:" followed by newline, "Line 2", tab, "tabbed", newline appears
5. Press Ctrl+Shift+K again to verify slow mode works (visibly slower typing)
  </verify>
  <done>
End-to-end test demonstrates all three requirements:
- INJT-01: Text types into focused application
- INJT-02: Special keys (Enter, Tab) work in sequence
- INJT-03: Configurable delay (instant vs slow) works
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete keystroke injection pipeline: permission check, modifier release, text typing, special keys, configurable delay.
  </what-built>
  <how-to-verify>
1. Run `cargo run` from terminal
2. Observe console output: should show "Keystroke injector initialized" and "Registered test hotkey: Ctrl+Shift+K"
3. **On macOS:** If first run, grant Accessibility permission when prompted (System Preferences > Privacy & Security > Accessibility > enable KeyBlast)
4. Open any text editor (TextEdit, VS Code, Notes, terminal)
5. Click to focus on text input area
6. Press Ctrl+Shift+K
7. Expected: "KeyBlast test:" appears, followed by newline, "Line 2", tab character, "tabbed", newline
8. Press Ctrl+Shift+K again - should type more slowly (20ms between keystrokes)
9. Verify Enable/Disable toggle: Right-click tray > uncheck Enable > press hotkey > nothing should happen

**Expected console output:**
```
KeyBlast initializing...
Keystroke injector initialized
Registered test hotkey: Ctrl+Shift+K
...
Hotkey triggered: test
Injecting macro (instant): KeyBlast test:{Enter}Line 2{Tab}tabbed{Enter}
Injection complete
```
  </how-to-verify>
  <resume-signal>Type "approved" if injection works correctly, or describe any issues observed</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. `cargo build --release` succeeds
2. Manual test: Ctrl+Shift+K types text into focused application
3. Special keys (Enter, Tab) create expected whitespace/navigation
4. Slow mode visibly types character by character
5. Disabled state prevents injection
6. macOS accessibility permission is requested on first run
</verification>

<success_criteria>
- INJT-01: Triggered macro types text into the currently focused input
- INJT-02: Special keys (Enter, Tab, Escape, arrows) work in sequences
- INJT-03: User can configure per-macro keystroke delay (demonstrated via instant vs slow toggle)
- Permission check guides macOS users to grant Accessibility access
- Enable/disable toggle correctly gates macro execution
</success_criteria>

<output>
After completion, create `.planning/phases/3-keystroke-injection/03-02-SUMMARY.md`
</output>
